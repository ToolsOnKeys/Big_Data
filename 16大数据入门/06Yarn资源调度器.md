# Yarn资源调度器

​         Yarn是一个资源调度平台，负责为运算程序提供服务器运算资源，相当于一个分布式的操作系统平台，而MapReduce等运算程序则相当于运行于系统之上过的应用程序。

## 1、Yarn基本框架

### ①、Yarn架构

* RM
  * 1、处理客户端请求
  * 2、监控NodeManager
  * 3、启动或监控AM
  * 4、资源的分配和调度
* NM
  * 1、管理单个节点上的资源
  * 2、处理来自RM的命令
  * 3、处理来自AM的命令
* AM
  * 1、负责数据的切分
  * 2、为应用程序申请资源，并分配给内部的任务
  * 3、任务的监控与容错
* Container
  * Yarn中的资源的抽象，封装了某个节点上的多维度资源

### ②、Yarn工作机制

![](D:\BigData\BigData\16大数据入门\相关说明图片\Yarn工作机制.png)

* 1、MR程序提交到客户端所在的节点
* 2、YarnRunner向RM申请一个Application。
* 3、RM将该应用程序的资源路径返回给YarnRunner。
* 4、该程序间运行所需资源提交到HDFS。
* 5、程序资源提交完毕后，申请运行mrAppMaster。
* 6、RM将用户的申请初始化成一个Task。
* 7、其中一个NM领取到Task任务
* 8、该NM创建容器Container，并产生MRAppmaster。
* 9、Container从HDFS上拷贝资源到本地。
* 10、MRAppmaster向RM申请MapTask资源。
* 11、RM间运行MapTask任务分配给另外两个NM，另外两个NM分别领取任务并创建容器。
* 12、MR想两个接收到任务的NM发送程序启动脚本，这两个NM分别启动MapTask，MapTask对数据分区排序。
* 13、MrAppMaster等待所有MapTask运行完毕后，向RM申请容器，运行ReduceTask。
* 14、ReduceTask向MapTask获取相应分区的数据。
* 15、程序运行完毕后，MR会向RM申请注销自己。

### ③、作业提交全过程

### ④、资源调度器

目前，Hadoop作业调度器主要分为三种：FIFO、Capacity Scheduler（Hadoop默认，yarn-default.xml）和Fair Scheduler。

* 1、先进先出调度器（FIFO）

  按照到达时间排序，先到先服务；有资源先分配给先进入的job

  * 1、有新的服务器节点资源
  * 2、Job1里面包含4个MapTask和2个ReduceTask

* 2、容量调度器（Capacity Scheduler）

  * 1、支持多个队列，每个队列可配置一定的资源量，每个队列采用FIFO调度策略。
  * 2、为了防止同一个用户的作业独占队列中的资源，该调度器会对同一用户提交的作业所占资源量进行限定。
  * 3、首先，计算每个队列中正在运行的任务数于其应该分的计算资源之间的比值，选择一个该比值最小的队列-最闲的。
  * 4、其次，按照作业优先级和提交时间顺序，同时考虑用户资源量限制和内存限制对队列内任务排序
  * 5、三个队列同时按照任务的先后顺序依次执行，三个队列之间是并行运行。
  * 6、特点：
    * 容量保证：管理员可为每个队列设置资源最低保证和资源使用上限，而所有提交到该队列的应用程序共享这些资源。
    * 灵活性：如果一个队列中的资源有剩余，可以暂时贡献给那些需要资源的队列，而一旦该队列有新的应用程序提交，则其他队列释放的资源会归还给该队列。这种资源灵活分配的方式可明显提高资源利用率。
    * 多重租赁：支持多用户共享集群和多应用程序同时运行。为防止单个应用程序、用户或者队列独占集群中的资源，管理员可谓之增加多重约束（比如单个应用程序同时运行的任务数有规定等）
    * 安全保证：每个队列有严格的ACL列表规定它的访问用户，每个用户可指定哪些用户允许查看自己应用程序的运行状态或者控制应用程序（比如杀死应用程序）。此外，管理员可指定队列管理员和集群系统管理员。
    * 动态更新配置文件：管理员可根据需要动态修改各种配置参数，以实现在线集群管理。

* 3、公平调度器（Fair Scheduler）

  * 1、同队列所有任务共享资源，再时间尺度上获得公平的资源。
  * 2、支持多队列多作业，每个队列可以单独配置
  * 3、同一个队列的作业按照其优先级分享整个队列的资源，并发执行
  * 4、每个作业可以设置最小资源值，调度器会保证作业获得其以上的资源。
  * 5、公平调度器的设计目标是：在时间尺度上，所有作业获得公平的资源。某一个时刻一个作业应获资源和实际获取的资源的差距叫缺额
  * 6、调度器会优先缺额大的作业分配支援。

* 总结公平调度器和容量调度器的差异
  * 资源公平共享：在每个队列中，公平调度器可以选择按照FIFO、Fair或DRF策略为应用程序分配资源。其中，Fair策略（默认）是一种基于最大最小公平算法实现得资源多路复用方法，默认情况下，每个队列内部采用该方式分配资源。这意味着，如果一个队列中有两个应用程序同时运行，则每个应用程序可得到1/2的资源；如果三个应用程序同时运行，则每个应用程序可得到1/3的资源
  * 支持资源抢占
  * 负载均衡
  * 调度策略配置灵活
  * 提高小应用相应时间

### ⑤、容量调度器多队列提交案列



### ⑥、任务推测执行

* 1、作业完成时间取决于最慢的任务完成时间
* 2、推测执行机制
* 3、执行推测任务的前提条件
* 4、不能启用推测执行机制的情况：
  * 任务间存在严重的负载倾斜。
  * 特殊任务，比如任务向数据库数据库中写数据。
* 5、算法原理